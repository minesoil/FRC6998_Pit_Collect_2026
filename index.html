<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>6998 | 2026 Pit Collect</title>
    
    <!-- 
      LIBRARIES:
      1. qrcode.js: Converts text into a visible QR code image.
      2. lz-string: Compresses large text strings into smaller Base64 strings to fit more data in a QR code.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           CSS STYLING & THEME
           Defines the dark mode look, colors, and responsive layout.
        ========================================= */
        
        /* CSS VARIABLES (Theme Configuration) */
        :root {
            --bg-deep: #050505;       /* Main background color (Very dark grey) */
            --bg-card: #141419;       /* Card background color */
            --accent: #D4AF37;        /* Gold accent color (Team Brand) */
            --accent-dim: #b89b00;    /* Darker gold for hover states */
            --text-main: #ffffff;     /* Primary text color */
            --text-secondary: #a0a0a0;/* Secondary text color (Subtitles) */
            --danger: #ff4444;        /* Red for danger/errors */
            --success: #00C851;       /* Green for success */
            --input-bg: #1f1f26;      /* Input field background */
            --border: rgba(255, 215, 0, 0.2); /* Subtle gold border */
        }

        /* GLOBAL RESET */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Lexend', sans-serif; 
            -webkit-tap-highlight-color: transparent; /* Removes blue highlight tap effect on mobile */
        }
        
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-main); 
            padding-bottom: 100px; /* Space for fixed bottom nav bar */
        }

        /* HEADER STYLES */
        header {
            background: linear-gradient(180deg, #1a1a20 0%, var(--bg-deep) 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--accent);
            position: sticky; /* Sticks to top when scrolling */
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.7);
        }
        header h1 { 
            color: var(--accent); 
            font-weight: 800; 
            letter-spacing: 2px; 
            font-size: 1.4rem; 
            text-transform: uppercase; 
        }
        /* Robot Counter Badge */
        .counter-badge {
            position: absolute; top: 20px; right: 20px;
            font-size: 0.75rem; color: var(--accent); border: 1px solid var(--accent);
            padding: 4px 8px; border-radius: 8px; font-weight: 600;
        }

        /* LAYOUT CONTAINERS */
        .container { max-width: 650px; margin: 0 auto; padding: 20px; }
        
        /* PAGE ANIMATIONS */
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* COMPONENT STYLES */
        .section-title {
            color: var(--text-secondary); font-size: 0.85rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; margin: 25px 0 10px 5px;
            border-left: 3px solid var(--accent); padding-left: 10px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        /* INPUT FIELDS */
        label { display: block; font-size: 0.9rem; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        .sub-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 8px; display: block; }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 14px; background: var(--input-bg);
            border: 1px solid #333; border-radius: 10px;
            color: white; font-size: 1rem; outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); }
        
        .violation { border-color: var(--danger) !important; background: rgba(255, 68, 68, 0.1) !important; }

        /* TOGGLE BUTTONS (Checkboxes styled as buttons) */
        .grid-select { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px; 
            margin-top: 10px; 
        }
        
        .toggle-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 10px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-secondary);
        }
        /* Hide actual checkbox input */
        .toggle-btn input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        
        /* Selected State */
        .toggle-btn:has(input:checked) {
            background: rgba(255, 215, 0, 0.15); /* Gold Tint */
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        /* NAVIGATION BAR */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex; gap: 15px;
            border-top: 1px solid #333;
            z-index: 1000;
        }
        .btn {
            flex: 1; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-back { background: #2a2a2a; color: #fff; }
        .btn-next { background: var(--accent); color: #000; }
        .btn-next:disabled { background: #444; color: #888; opacity: 0.7; cursor: not-allowed; box-shadow: none; }

        /* CANVAS STYLES (Field Map) */
        #fieldContainer {
            position: relative;
            width: 100%;
            padding-bottom: 50%; /* Enforces 2:1 Aspect Ratio (Width:Height) */
            background: #2a2a2a;
            border-radius: 12px;
            border: 2px solid var(--accent);
            overflow: hidden;
            margin-bottom: 15px;
        }
        #fieldCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            background-color: #333; 
            /* IMPORTANT: This image file must exist in the same folder */
            background-image: url('field_2026.png'); 
            background-size: cover;
            background-position: center;
        }
        .drawing-controls { display: flex; gap: 10px; margin-bottom: 10px; }

        /* QR CODE DISPLAY */
        .team-display { margin-top: 10px; font-size: 0.9rem; font-weight: bold; color: var(--accent); display: inline-block; padding: 5px 10px; background: rgba(255,215,0,0.1); border-radius: 8px; }
        .error-msg { color: var(--danger); font-size: 0.75rem; font-weight: bold; margin-top: 5px; display: none; }
        #qrcode, #qrcodePath { background: white; padding: 15px; border-radius: 10px; margin: 20px auto; width: fit-content; display: none; }
        
        .profanity-alert {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid var(--danger);
            color: #ffcccc;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 10px;
            display: none;
            font-weight: bold;
            text-align: center;
        }

        .conditional-input { margin-top: 15px; display: none; animation: fadeIn 0.3s ease; }
    </style>
</head>
<body>

<header>
    <h1>6998 | 2026 Pit Collect | By Justin</h1>
    <div class="counter-badge" id="robotCounter">ROBOTS: 0</div>
</header>

<div class="container">
    <form id="scoutForm">

        <!-- STEP 1: Identification -->
        <div class="page active" id="page0">
            <div class="section-title">Step 1: Identification</div>
            
            <div class="card">
                <label>Scouter Name (你的名字)</label>
                <input type="text" id="scouterName" placeholder="First & Last Name">
                <div class="error-msg" id="err-name">Invalid Name</div>
                <div class="profanity-alert" id="profanity-name">Please remove inappropriate language.</div>
            </div>

            <div class="card">
                <label>Team Number (隊伍編號)</label>
                <input type="number" id="teamNum" placeholder="e.g. 6998">
                <div id="teamNameDisplay" class="team-display">Waiting for input...</div>
                <div class="error-msg" id="err-team">Unknown or Invalid Team Number</div>
            </div>
        </div>

        <!-- STEP 2: Robot Specifications -->
        <div class="page" id="page1">
            <div class="section-title">Step 2: Robot Specifications</div>

            <div class="card">
                <label>Chassis Type (底盤)</label>
                <select id="chassis">
                    <option value="Swerve">Swerve</option>
                    <option value="Tank">Tank</option>
                    <option value="Mecanum">Mecanum</option>
                    <option value="Other">Other</option>
                </select>
                
                <br><br>
                <label>Robot Weight (機器人重量)</label>
                <span class="sub-label">In Pounds (lbs)</span>
                <input type="number" id="weight" placeholder="125">
                <div class="error-msg" id="err-weight">Max Weight is 135 lbs</div>
                
                <br><br>
                <label>Max Fuel Capacity (最高容量)</label>
                <input type="number" id="capacity" placeholder="e.g. 1">
            </div>

            <!-- STEP 3: Systems -->
            <div class="section-title">Step 3: Systems</div>

            <div class="card">
                <label>Intake Mechanism (Intake)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="intake" value="Roller">
                        Roller
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="intake" value="Pneumatic">
                        Pneumatic
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="intake" id="intakeOtherTrigger">
                        Other (其他)
                    </label>
                </div>
                <div class="conditional-input" id="intakeOtherBox">
                    <input type="text" id="intakeOtherVal" placeholder="Describe intake type...">
                </div>
            </div>

            <div class="card">
                <label>Vision Hardware (視覺硬體)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="visionHard" value="Limelight">
                        Limelight
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="visionHard" value="NormalCamera">
                        Normal Camera
                    </label>
                     <label class="toggle-btn">
                        <input type="checkbox" name="visionHard" id="visOtherTrigger">
                        Other (其他)
                    </label>
                </div>
                <div class="conditional-input" id="visOtherBox">
                    <input type="text" id="visOtherVal" placeholder="Describe camera/vision...">
                </div>
            </div>

            <div class="card">
                <label>Vision Capabilities (相機功能)</label>
                 <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="visionSoft" value="ObjDetect">
                        Object Detection
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="visionSoft" value="AprilTag">
                        AprilTag
                    </label>
                     <label class="toggle-btn">
                        <input type="checkbox" name="visionSoft" id="visSoftOtherTrigger">
                        Other (其他)
                    </label>
                </div>
                <div class="conditional-input" id="visSoftOtherBox">
                    <input type="text" id="visSoftOtherVal" placeholder="Describe vision capabilities...">
                </div>
            </div>

            <div class="card">
                <label>Shooting Capabilities (射球能力)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="shoot" value="MoveShoot">
                        邊走邊射<br><span style="font-size:0.7em">(Move & Shoot)</span>
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="shoot" value="IntakeShoot">
                        邊吸邊射<br><span style="font-size:0.7em">(Intake & Shoot)</span>
                    </label>
                </div>
            </div>

            <div class="card">
                <label>Turret Features (砲台)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="turret" value="Yaw">
                        Yaw (Horizontal)
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="turret" value="Pitch">
                        Pitch (Vertical)
                    </label>
                </div>
            </div>
        </div>

        <!-- STEP 4: Autonomous -->
        <div class="page" id="page2">
            <div class="section-title">Step 4: Autonomous</div>

            <div class="card">
                <label>Starting Location (位子)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="startPos" value="Left">
                        Left (左)
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="startPos" value="Center">
                        Center (中)
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="startPos" value="Right">
                        Right (右)
                    </label>
                </div>

                <br><br>
                <label>Preload Count (Preload 數量)</label>
                <span class="sub-label">Maximum 8</span>
                <input type="number" id="preload" placeholder="0" max="8">
                <div class="error-msg" id="err-preload">Max Preload is 8</div>
            </div>

             <div class="card">
                <label>Auto Intake Source (自動吸球來源)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoIntakePos" value="Ground">
                        Ground
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoIntakePos" value="Outpost">
                        Outpost
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoIntakePos" value="Depot">
                        Depot
                    </label>
                </div>
            </div>

            <div class="card">
                <label>Auto Hang Location (自動掛 L1 位置)</label>
                <div class="grid-select" style="grid-template-columns: repeat(3, 1fr);">
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoHangPos" value="Left">
                        Left<br>左
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoHangPos" value="Center">
                        Center<br>中
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoHangPos" value="Right">
                        Right<br>右
                    </label>
                </div>
                <div class="grid-select" style="margin-top:10px;">
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoHangPos" value="FarLeft">
                        Far Left Side (左側)
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="autoHangPos" value="FarRight">
                        Far Right Side (右側)
                    </label>
                </div>
            </div>

            <div class="card">
                <label>Total Auto Fuel (Auto 總共顆數)</label>
                <span class="sub-label">Scored during Auto</span>
                <input type="number" id="autoTotal" placeholder="0">
            </div>

            <div class="card">
                <label class="toggle-btn" style="width:100%;">
                    <input type="checkbox" id="crossMid" onchange="toggleTerrainSection()">
                    Cross Midfield (會不會過中場)
                </label>
            </div>

            <div class="card" id="terrainCard" style="display:none;">
                <label>Terrain Navigation (地形)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="terrain" value="Bump" id="terrainBump">
                        Bump
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="terrain" value="Trench">
                        Trench
                    </label>
                </div>
            </div>
        </div>

        <!-- STEP 5: Teleop & Endgame -->
        <div class="page" id="page3">
            <div class="section-title">Step 5: Teleop & Endgame</div>

            <div class="card">
                <label>Climb Capability (吊掛能力)</label>
                <div class="grid-select">
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbLvl" value="L1">
                        L1
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbLvl" value="L2">
                        L2
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbLvl" value="L3">
                        L3
                    </label>
                </div>
            </div>

            <div class="card">
                <label>Climb Position (吊掛位子)</label>
                <div class="grid-select" style="grid-template-columns: repeat(3, 1fr);">
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbPos" value="Left">
                        Left<br>左
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbPos" value="Center">
                        Center<br>中
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbPos" value="Right">
                        Right<br>右
                    </label>
                </div>
                <div class="grid-select" style="margin-top:10px;">
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbPos" value="FarLeft">
                        Far Left Side (左側)
                    </label>
                    <label class="toggle-btn">
                        <input type="checkbox" name="climbPos" value="FarRight">
                        Far Right Side (右側)
                    </label>
                </div>
            </div>

            <div class="card">
                <label>Climb Time (吊掛時間)</label>
                <span class="sub-label">Estimated seconds to climb</span>
                <input type="number" id="climbTime" placeholder="e.g. 5">
            </div>

            <div class="card">
                <label style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="photosTaken" style="width:25px; height:25px; accent-color:var(--accent);">
                    <span>Photos Taken? (照片全部已拍)</span>
                </label>
            </div>

            <div class="card">
                <label>General Notes (備註)</label>
                <textarea id="notes" rows="4" placeholder="Driver skill, defense, reliability notes..."></textarea>
                <div class="profanity-alert" id="profanity-notes">Please remove inappropriate language.</div>
            </div>
        </div>

        <!-- STEP 6: Review & Sync -->
        <div class="page" id="page4">
            <div class="section-title">Step 6: Review & Sync</div>
            <div class="card" style="text-align:center;">
                <h2 style="color:var(--accent); margin-bottom:10px;">Ready to Generate</h2>
                <div id="reviewText" style="text-align:left; background:#000; padding:15px; border-radius:10px; margin-bottom:20px; font-size:0.9rem; line-height:1.6; color:#ccc;">
                </div>

                <!-- ADDED: Big Team Label for Data QR -->
                <div id="qrHeader" style="display:none; margin-bottom:15px;">
                    <div style="color:var(--text-secondary); font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">Scouting Team</div>
                    <div id="qrTeamText" style="color:var(--accent); font-size:2.5rem; font-weight:800; line-height:1.2;"></div>
                    <div id="qrTeamName" style="color:white; font-size:1.2rem; margin-top:5px;"></div>
                </div>

                <div id="qrcode"></div>
                
                <button type="button" class="btn btn-next" id="generateBtn" onclick="generateQR()">Generate Data QR</button>
                <br><br>
                <!-- NEW BUTTON: Only visible after generating first QR -->
                <button type="button" class="btn btn-next" id="goToPathBtn" onclick="navigate(1)" style="display:none; background: #2a2a2a; border: 1px solid var(--accent); color: var(--accent);">Next: Draw Auto Path</button>
                
                <br><br>
                <button type="button" class="btn" style="background:var(--danger); color:white; font-size:0.8rem; padding:10px;" onclick="resetForm()">Reset Form</button>
            </div>
        </div>

        <!-- NEW STEP 7: Auto Path Drawing (Page 5) -->
        <div class="page" id="page5">
            <div class="section-title">Step 7: Draw Auto Path</div>
            <div class="card" style="text-align:center;">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                    Draw the robot's autonomous path. (Lift finger to start new line)<br>
                    <span style="font-size: 0.8rem; color: var(--accent);">Map: FRC 2026 Rebuilt Field</span>
                </p>

                <div class="drawing-controls" style="justify-content: center;">
                    <button type="button" class="btn" style="background: #333; color: white; padding: 10px;" onclick="clearCanvas()">Clear</button>
                    <button type="button" class="btn" style="background: #333; color: white; padding: 10px;" onclick="undoLastStroke()">Undo</button>
                </div>

                <!-- Canvas Container -->
                <div id="fieldContainer">
                    <canvas id="fieldCanvas"></canvas>
                </div>

                <!-- ADDED: Big Team Label for Path QR -->
                <div id="pathQrHeader" style="display:none; margin-bottom:15px; border-top: 1px solid #333; padding-top:15px;">
                    <div style="color:var(--text-secondary); font-size:0.9rem; text-transform:uppercase; letter-spacing:1px;">Auto Paths For</div>
                    <div id="pathQrTeamText" style="color:var(--accent); font-size:2rem; font-weight:800;"></div>
                </div>

                <div id="qrcodePath"></div>

                <button type="button" class="btn btn-next" id="generatePathBtn" onclick="generatePathQR()">Generate Path QRs</button>
                <br><br>
                <button type="button" class="btn" style="background:var(--danger); color:white; font-size:0.8rem; padding:10px;" onclick="resetForm()">Finish & Reset</button>
            </div>
        </div>

    </form>
</div>

<!-- Navigation Bar -->
<div class="nav-bar">
    <button type="button" class="btn btn-back" id="backBtn" onclick="navigate(-1)">Back</button>
    <button type="button" class="btn btn-next" id="nextBtn" onclick="navigate(1)">Next</button>
</div>

<script>
    /* =========================================
       CONFIGURATION & DATA
       ========================================= */
    const TEAM_LIST = {
        364: "Team Fusion",
        456: "Siege Robotics",
        538: "Renaissance Robotics",
        590: "Chahta Warriors",
        1421: "Team CHAOS",
        1912: "Team Combustion",
        1927: "Tempest",
        2221: "FHS Robodawgs",
        2556: "RadioActive Roaches",
        2992: "The S.S. Prometheus",
        3039: "Wildcat Robotics",
        3606: "BearMetal",
        3616: "Team Phenomena",
        3753: "BulahBots!",
        4087: "Voodoo Voltage",
        4107: "Team Storm",
        4336: "Ramageddon Robotics",
        4400: "Cerbotics - Peñoles",
        5045: "SpartaBot",
        5863: "Hypercubed",
        5971: "Raider Robotics Team",
        6184: "C4 (Capital City Chaotic Coders)",
        6706: "Golem",
        6998: "Unipards",
        7094: "Alpha Omega",
        7474: "JXN UNITED",
        8044: "Denham Venom",
        8624: "Sasquatch Robotics",
        8808: "SWLA Tech Pirates",
        9153: "Bearcat Robotics",
        9309: "Metal Mages",
        9405: "RouxBots",
        9503: "EF5 CHAOS",
        9717: "Poultronix",
        9734: "Jasper County Robotics",
        10101: "Critical Hit",
        10217: "Catahoula Blue Dogs",
        10309: "Jayhawks Robotics",
        10661: "Blue Phoenix",
        10929: "Tarpon Robotics",
        10943: "WJH RoboStangs",
        10961: "Hyper Wave",
        11107: "FARMBots",
        11265: "Rockbotics -FRC",
        11287: "Canton Career Center",
        11343: "JPS High School Robotics",
        11345: "Long Beach RoboBearcats"
    };

    // Words blocked by the profanity filter
    const BAD_WORDS = ["damn", "hell", "shit", "fuck", "bitch", "crap", "ass", "bastard", "dick", "piss", "cock", "pussy", "slut", "whore", "nigger", "fag", "retard", "sex", "nude", "gyatt", "nigga","hitler", "nigg"];
    
    // State Variable for Navigation
    let currentPage = 0; 
    
    /* =========================================
       UI LOGIC HANDLERS
       ========================================= */
    
    // Handles conditional inputs (e.g., checking "Other" reveals a text box)
    function setupOtherToggle(triggerId, boxId) {
        document.getElementById(triggerId).addEventListener('change', function(e) {
            const box = document.getElementById(boxId);
            if(e.target.checked) {
                box.style.display = 'block';
                box.querySelector('input').focus();
            } else {
                box.style.display = 'none';
                box.querySelector('input').value = ''; 
            }
        });
    }

    // Set up toggles for specific inputs
    setupOtherToggle('intakeOtherTrigger', 'intakeOtherBox');
    setupOtherToggle('visOtherTrigger', 'visOtherBox');
    setupOtherToggle('visSoftOtherTrigger', 'visSoftOtherBox');

    // Logic for exclusive checkboxes (acting like radio buttons but styled as boxes)
    document.querySelectorAll('.exclusive-check').forEach(box => {
        box.addEventListener('change', (e) => {
            const group = e.target.dataset.group;
            if(!group) return; 
            if (e.target.checked) {
                document.querySelectorAll(`input[data-group="${group}"]`).forEach(el => { 
                    if(el !== e.target) el.checked = false; 
                });
            }
        });
    });

    // Shows/Hides Terrain section based on "Cross Midfield" toggle
    function toggleTerrainSection() {
        const crossMid = document.getElementById('crossMid').checked;
        const card = document.getElementById('terrainCard');
        if(crossMid) {
            card.style.display = 'block'; 
        } else {
            card.style.display = 'none'; 
            document.querySelectorAll('input[name="terrain"]').forEach(cb => cb.checked = false);
        }
    }

    // Displays Team Name when a number is typed
    document.getElementById('teamNum').addEventListener('input', function() {
        const num = this.value;
        const disp = document.getElementById('teamNameDisplay');
        if(TEAM_LIST[num]) {
            disp.textContent = "✓ " + TEAM_LIST[num];
            disp.style.color = "#000";
            disp.style.background = "var(--accent)";
        } else {
            disp.textContent = num ? "Unknown Team" : "Waiting for input...";
            disp.style.color = num ? "var(--text-secondary)" : "var(--accent)";
            disp.style.background = "rgba(255,255,255,0.05)";
        }
        updateNavButtons(); 
    });

    // Real-time Validation Listeners
    const inputsToMonitor = ['scouterName', 'notes', 'weight', 'capacity', 'preload', 'autoTotal', 'climbTime', 'intakeOtherVal', 'visOtherVal', 'visSoftOtherVal'];
    inputsToMonitor.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', updateNavButtons);
    });

    // Helper: Normalize text for profanity checking
    function normalizeText(text) {
        return text.toLowerCase().replace(/[@]/g, "a").replace(/[1!]/g, "i").replace(/[3]/g, "e").replace(/[4]/g, "a").replace(/[5$]/g, "s").replace(/[0]/g, "o").replace(/[^a-z]/g, "").replace(/(.)\1+/g, "$1");
    }

    // Helper: Check for bad words
    function containsProfanity(text) {
        if (!text) return false;
        const lower = text.toLowerCase();
        return BAD_WORDS.some(word => {
            const regex = new RegExp(`\\b${word}\\b`, "i");
            return regex.test(lower);
        });
    }

    /* =========================================
       NAVIGATION & VALIDATION SYSTEM
       ========================================= */

    function updateNavButtons() {
        const nextBtn = document.getElementById('nextBtn');
        let isValid = true;

        // --- PAGE 0: IDENTIFICATION ---
        if (currentPage === 0) {
            const name = document.getElementById('scouterName').value.trim();
            const team = document.getElementById('teamNum').value.trim();
            
            // Profanity Check
            if(containsProfanity(name)) {
                document.getElementById('profanity-name').style.display = 'block';
                document.getElementById('scouterName').classList.add('violation');
                isValid = false;
            } else {
                document.getElementById('profanity-name').style.display = 'none';
                document.getElementById('scouterName').classList.remove('violation');
            }
            
            // Basic Rules
            if (name.length < 2) isValid = false;
            
            // Team must be in the list? (Optional logic, currently warns but blocks if invalid)
            if (!TEAM_LIST[team]) {
                document.getElementById('err-team').style.display = team ? 'block' : 'none';
                isValid = false;
            } else {
                document.getElementById('err-team').style.display = 'none';
            }
        }
        // --- PAGE 1: SPECS & SYSTEMS ---
        else if (currentPage === 1) {
            const weightVal = document.getElementById('weight').value;
            const capVal = document.getElementById('capacity').value;
            const weight = parseFloat(weightVal);
            
            if (weightVal === '' || capVal === '') { isValid = false; }
            else if (weight > 135) {
                document.getElementById('err-weight').style.display = 'block';
                document.getElementById('weight').classList.add('violation');
                isValid = false;
            } else {
                document.getElementById('err-weight').style.display = 'none';
                document.getElementById('weight').classList.remove('violation');
            }
            
            // Required "Other" text fields
            if(document.getElementById('intakeOtherBox').style.display === 'block' && document.getElementById('intakeOtherVal').value.trim() === '') isValid = false;
            if(document.getElementById('visOtherBox').style.display === 'block' && document.getElementById('visOtherVal').value.trim() === '') isValid = false;
            if(document.getElementById('visSoftOtherBox').style.display === 'block' && document.getElementById('visSoftOtherVal').value.trim() === '') isValid = false;
        }
        // --- PAGE 2: AUTONOMOUS ---
        else if (currentPage === 2) {
            const preloadVal = document.getElementById('preload').value;
            const autoTotalVal = document.getElementById('autoTotal').value;
            const preload = parseFloat(preloadVal);
            const capacity = parseFloat(document.getElementById('capacity').value) || 0;
            const errPreload = document.getElementById('err-preload');
            
            if (preloadVal === '' || autoTotalVal === '') { isValid = false; }
            
            if (preload > 8) {
                errPreload.innerText = "Max Preload is 8";
                errPreload.style.display = 'block';
                document.getElementById('preload').classList.add('violation');
                isValid = false;
            } else if (preload > capacity) {
                errPreload.innerText = "Preload > Capacity (" + capacity + ")";
                errPreload.style.display = 'block';
                document.getElementById('preload').classList.add('violation');
                isValid = false;
            } else {
                errPreload.style.display = 'none';
                document.getElementById('preload').classList.remove('violation');
            }
        }
        // --- PAGE 3: TELEOP ---
        else if (currentPage === 3) {
             const climbTimeVal = document.getElementById('climbTime').value;
             const notes = document.getElementById('notes').value;
             if (climbTimeVal === '') isValid = false;
             
             if(containsProfanity(notes)) {
                document.getElementById('profanity-notes').style.display = 'block';
                document.getElementById('notes').classList.add('violation');
                isValid = false;
             } else {
                document.getElementById('profanity-notes').style.display = 'none';
                document.getElementById('notes').classList.remove('violation');
             }
        }

        nextBtn.disabled = !isValid;
    }

    function navigate(dir) {
        if (dir === 1 && document.getElementById('nextBtn').disabled) return; 

        // Hide current page
        document.getElementById(`page${currentPage}`).classList.remove('active');
        currentPage += dir;
        // Show next page
        document.getElementById(`page${currentPage}`).classList.add('active');
        
        // Handle Back Button Visibility
        document.getElementById('backBtn').style.visibility = currentPage === 0 ? 'hidden' : 'visible';
        
        // Special Page Handling
        if(currentPage === 4) { // Review Page
            document.getElementById('nextBtn').style.display = 'none';
            prepareReview();
        } 
        else if (currentPage === 5) { // Path Drawing Page
            document.getElementById('nextBtn').style.display = 'none';
            initCanvas(); // Initialize canvas
        }
        else {
            document.getElementById('nextBtn').style.display = 'block';
            updateNavButtons();
        }
        window.scrollTo(0,0);
    }

    function getMultiValues(name, otherId = null) {
        let vals = [];
        document.querySelectorAll(`input[name="${name}"]:checked`).forEach(cb => {
            if(otherId && cb.id.includes('Other')) {
                const txt = document.getElementById(otherId).value.trim();
                if(txt) vals.push("Other: " + txt);
            } else {
                vals.push(cb.value);
            }
        });
        return vals.join(' + ');
    }

    /* =========================================
       REVIEW & QR GENERATION (DATA)
       ========================================= */

    function prepareReview() {
        const t = document.getElementById('teamNum').value;
        const name = TEAM_LIST[t] || "Unknown";
        
        let html = `<strong>Team ${t} - ${name}</strong><br>`;
        html += `Scouter: ${document.getElementById('scouterName').value}<br>`;
        html += `<hr style="border-color:#333; margin:5px 0;">`;
        html += `Chassis: ${document.getElementById('chassis').value}<br>`;
        html += `Auto Intake: ${getMultiValues('autoIntakePos') || 'None'}<br>`;
        html += `Auto Hang: ${getMultiValues('autoHangPos') || 'None'}<br>`;
        
        document.getElementById('reviewText').innerHTML = html;
    }

    function generateQR() {
        const teamNum = document.getElementById('teamNum').value;
        const teamName = TEAM_LIST[teamNum] || "Unknown Team";
        
        // 1. Collect Data Object
        const data = {
            t: parseInt(teamNum),
            sc: document.getElementById('scouterName').value.replace(/\t/g, ' ').replace(/\n/g, ' '),
            dt: document.getElementById('chassis').value,
            wt: document.getElementById('weight').value,
            mx: document.getElementById('capacity').value,
            in: getMultiValues('intake', 'intakeOtherVal'),
            visH: getMultiValues('visionHard', 'visOtherVal'),
            visS: getMultiValues('visionSoft', 'visSoftOtherVal'),
            sht: getMultiValues('shoot'),
            tur: getMultiValues('turret'),
            stL: getMultiValues('startPos'),
            pre: document.getElementById('preload').value,
            auInt: getMultiValues('autoIntakePos') || 'None', 
            auHng: getMultiValues('autoHangPos') || 'None',
            at: document.getElementById('autoTotal').value,
            mid: document.getElementById('crossMid').checked ? 1 : 0,
            ter: getMultiValues('terrain'),
            cLv: getMultiValues('climbLvl'),
            cPs: getMultiValues('climbPos'),
            cTm: document.getElementById('climbTime').value,
            ph: document.getElementById('photosTaken').checked ? 1 : 0,
            nt: document.getElementById('notes').value.replace(/\t/g, ' ').replace(/\n/g, ' ')
        };

        // 2. Create TSV Array (Strict Order for Backend)
        const tsvValues = [
            data.t, data.sc, data.dt, data.wt, data.mx, 
            data.in, data.visH, data.visS, data.sht, data.tur,
            data.stL, data.pre, data.auInt, data.auHng, data.at, 
            data.mid, data.ter, 
            data.cLv, data.cPs, data.cTm, data.ph, data.nt
        ];

        // 3. Compress Data
        const tsvString = tsvValues.join('\t');
        const compressed = LZString.compressToBase64(tsvString);

        // 4. Update UI: Show Big Team Label
        document.getElementById('qrTeamText').innerText = `${teamNum}`;
        document.getElementById('qrTeamName').innerText = teamName;
        document.getElementById('qrHeader').style.display = "block";

        // 5. Render QR Code
        document.getElementById('qrcode').innerHTML = "";
        document.getElementById('qrcode').style.display = "block";
        
        new QRCode(document.getElementById("qrcode"), {
            text: compressed,
            width: 256,
            height: 256,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.L
        });
        
        document.getElementById('generateBtn').style.display = 'none';
        
        // Show button to proceed to Path Drawing
        document.getElementById('goToPathBtn').style.display = 'inline-block';

        // Update Local Counter
        const counter = document.getElementById('robotCounter');
        let count = parseInt(counter.innerText.split(': ')[1]) + 1;
        counter.innerText = "ROBOTS: " + count;
    }

    /* =========================================
       PATH DRAWING & GENERATION (STEP 7)
       ========================================= */
    const canvas = document.getElementById('fieldCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let strokes = []; // Stores array of lines: [ [{x,y}, {x,y}], [{x,y}...] ]
    let currentStroke = [];
    
    // Resize canvas to match the CSS-defined container size
    function initCanvas() {
        const container = document.getElementById('fieldContainer');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        drawFieldBackground();
    }

    // Handle Window Resize to keep canvas sharp
    window.addEventListener('resize', () => {
        if (currentPage === 5) initCanvas();
    });

    // Draw the Field and any existing strokes
    function drawFieldBackground() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // 1. Draw finished strokes
        if (strokes.length > 0) {
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = "#00C851"; // Green Path

            strokes.forEach(stroke => {
                if (stroke.length < 2) return;
                ctx.beginPath();
                // Convert percentage back to pixels
                const startX = (stroke[0].x / 100) * canvas.width;
                const startY = (stroke[0].y / 100) * canvas.height;
                ctx.moveTo(startX, startY);

                for (let i = 1; i < stroke.length; i++) {
                    const px = (stroke[i].x / 100) * canvas.width;
                    const py = (stroke[i].y / 100) * canvas.height;
                    ctx.lineTo(px, py);
                }
                ctx.stroke();
            });
        }

        // 2. Draw current stroke being drawn (live feedback)
        if (currentStroke.length > 1) {
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.strokeStyle = "#00C851"; 
            ctx.beginPath();
            const startX = (currentStroke[0].x / 100) * canvas.width;
            const startY = (currentStroke[0].y / 100) * canvas.height;
            ctx.moveTo(startX, startY);
            for (let i = 1; i < currentStroke.length; i++) {
                const px = (currentStroke[i].x / 100) * canvas.width;
                const py = (currentStroke[i].y / 100) * canvas.height;
                ctx.lineTo(px, py);
            }
            ctx.stroke();
        }
    }

    // --- Input Handling (Mouse & Touch) ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        
        if (e.changedTouches) {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }

        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function startDraw(e) {
        if(e.cancelable) e.preventDefault();
        isDrawing = true;
        currentStroke = []; // Start a new line
        const pos = getPos(e);
        addPoint(pos.x, pos.y);
    }

    function draw(e) {
        if (!isDrawing) return;
        if(e.cancelable) e.preventDefault();
        const pos = getPos(e);
        addPoint(pos.x, pos.y);
        drawFieldBackground();
    }

    function endDraw(e) {
        if (!isDrawing) return;
        if(e.cancelable) e.preventDefault();
        isDrawing = false;
        if (currentStroke.length > 0) {
            strokes.push(currentStroke); // Save the finished line
            currentStroke = [];
        }
        drawFieldBackground();
    }

    // Convert pixel coordinates to Percentage (0-100) for resolution independence
    function addPoint(pixelX, pixelY) {
        const xPct = parseFloat((pixelX / canvas.width * 100).toFixed(1));
        const yPct = parseFloat((pixelY / canvas.height * 100).toFixed(1));
        currentStroke.push({ x: xPct, y: yPct });
    }

    function clearCanvas() {
        strokes = [];
        currentStroke = [];
        drawFieldBackground();
        document.getElementById('qrcodePath').innerHTML = "";
        document.getElementById('qrcodePath').style.display = 'none';
        document.getElementById('pathQrHeader').style.display = 'none';
        document.getElementById('generatePathBtn').style.display = 'inline-block';
    }

    function undoLastStroke() {
        strokes.pop(); // Remove the most recent line
        drawFieldBackground();
    }

    // Attach Event Listeners to Canvas
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);
    
    canvas.addEventListener('touchstart', startDraw, {passive: false});
    canvas.addEventListener('touchmove', draw, {passive: false});
    canvas.addEventListener('touchend', endDraw, {passive: false});


    function generatePathQR() {
        if (strokes.length === 0) {
            alert("Please draw at least one path segment.");
            return;
        }

        const teamNum = document.getElementById('teamNum').value;
        const eventCode = "2026PIT"; 
        const matchNum = "0"; 

        // Update UI: Show Big Team Label for Path
        document.getElementById('pathQrTeamText').innerText = `Team ${teamNum}`;
        document.getElementById('pathQrHeader').style.display = "block";

        const qrContainer = document.getElementById('qrcodePath');
        qrContainer.innerHTML = ""; 
        qrContainer.style.display = "block";

        // Generate a separate QR code for EACH stroke/line drawn
        strokes.forEach((stroke, index) => {
            if (stroke.length < 2) return; 

            // Convert points to string: "x,y|x,y|..."
            const pathString = stroke.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join('|');
            
            // Protocol: Event | Match | Team | Path
            const tsvValues = [eventCode, matchNum, teamNum, pathString];
            const fullPayload = tsvValues.join('\t');

            // Compress payload
            const compressed = LZString.compressToBase64(fullPayload);

            // Create wrapper for the QR code
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = "20px";
            wrapper.style.padding = "15px";
            wrapper.style.background = "#fff";
            wrapper.style.borderRadius = "10px";
            wrapper.style.color = "#000";
            wrapper.style.textAlign = "center";

            const label = document.createElement('div');
            label.innerText = `Auto Path #${index + 1}`;
            label.style.fontWeight = "bold";
            label.style.marginBottom = "10px";
            label.style.fontSize = "1.1rem";
            
            const qrDiv = document.createElement('div');
            
            wrapper.appendChild(label);
            wrapper.appendChild(qrDiv);
            qrContainer.appendChild(wrapper);

            // Generate QR Code
            new QRCode(qrDiv, {
                text: compressed,
                width: 200,
                height: 200,
                colorDark : "#D4AF37", // Gold color for Path QRs
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });
        });
        
        document.getElementById('generatePathBtn').style.display = 'none';
    }

    function resetForm() {
        if(confirm("Are you sure you want to finish and reset?")) {
            document.getElementById('scoutForm').reset();
            
            // Hide "Other" inputs
            document.getElementById('intakeOtherBox').style.display = 'none';
            document.getElementById('visOtherBox').style.display = 'none';
            document.getElementById('visSoftOtherBox').style.display = 'none';
            document.getElementById('terrainCard').style.display = 'none';
            
            // Reset Displays
            const disp = document.getElementById('teamNameDisplay');
            disp.textContent = "Waiting for input...";
            disp.style.color = "var(--accent)";
            disp.style.background = "rgba(255,255,255,0.05)";
            
            // Reset Headers & Errors
            document.getElementById('qrHeader').style.display = "none";
            document.getElementById('pathQrHeader').style.display = "none";
            document.querySelectorAll('.error-msg').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.profanity-alert').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.violation').forEach(el => el.classList.remove('violation'));
            
            // Reset QRs
            document.getElementById('qrcode').innerHTML = "";
            document.getElementById('qrcode').style.display = "none";
            document.getElementById('qrcodePath').innerHTML = "";
            document.getElementById('qrcodePath').style.display = "none";
            
            // Reset Buttons
            document.getElementById('generateBtn').style.display = 'inline-block';
            document.getElementById('generatePathBtn').style.display = 'inline-block';
            document.getElementById('goToPathBtn').style.display = 'none'; 
            
            // Clear Path Data
            strokes = [];
            currentStroke = [];
            
            // Navigate Home
            document.querySelector('.page.active').classList.remove('active');
            currentPage = 0;
            document.getElementById('page0').classList.add('active');
            
            document.getElementById('backBtn').style.visibility = 'hidden';
            document.getElementById('nextBtn').style.display = 'block';
            updateNavButtons();
            
            window.scrollTo(0,0);
        }
    }

    // Run validation immediately on load
    updateNavButtons();
</script>
</body>
</html>
